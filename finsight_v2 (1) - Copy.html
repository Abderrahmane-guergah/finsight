<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinSight — Professional Market Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Playfair+Display:wght@400;700;900&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root {
  --bg:         #07090e;
  --bg2:        #0b0f1a;
  --panel:      rgba(11,17,30,0.92);
  --panel2:     rgba(16,24,40,0.85);
  --border:     rgba(255,255,255,0.06);
  --border2:    rgba(255,255,255,0.1);
  --gold:       #c9a84c;
  --gold-dim:   rgba(201,168,76,0.15);
  --gold-glow:  rgba(201,168,76,0.35);
  --teal:       #22d3b0;
  --teal-dim:   rgba(34,211,176,0.12);
  --red:        #f05d7a;
  --red-dim:    rgba(240,93,122,0.12);
  --text:       #d4dce8;
  --text2:      #8898aa;
  --text3:      #3d5068;
  --white:      #f0f4f8;
  --up:         #22d3b0;
  --dn:         #f05d7a;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html { height:100%; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  height: 100vh;
  overflow: hidden;
  cursor: default;
}

/* ── NOISE TEXTURE OVERLAY ── */
body::after {
  content:'';
  position:fixed; inset:0; z-index:9999; pointer-events:none;
  opacity:.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 200px 200px;
}

/* ── BACKGROUND GLOW ── */
body::before {
  content:'';
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse 80% 40% at 15% 50%, rgba(34,211,176,0.04) 0%, transparent 60%),
    radial-gradient(ellipse 60% 60% at 85% 20%, rgba(201,168,76,0.03) 0%, transparent 60%),
    radial-gradient(ellipse 100% 100% at 50% 100%, rgba(11,17,30,0.8) 0%, transparent 80%);
}

/* ══════════ LAYOUT ══════════ */
.app {
  position:relative; z-index:1;
  display:grid;
  grid-template-rows: 52px 36px 1fr 56px;
  grid-template-columns: 300px 1fr 280px;
  height: 100vh;
  gap: 0;
}

/* ══════════ HEADER ══════════ */
header {
  grid-column: 1/-1;
  display:flex; align-items:center; justify-content:space-between;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
  background: rgba(7,9,14,0.9);
  backdrop-filter: blur(20px);
  position:relative;
}
header::after {
  content:'';
  position:absolute; bottom:-1px; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--gold-glow), transparent);
}

.logo-mark {
  display:flex; align-items:center; gap:10px;
}
.logo-icon {
  width:28px; height:28px; position:relative;
  display:flex; align-items:center; justify-content:center;
}
.logo-icon svg { width:28px; height:28px; }
.logo-text {
  font-family:'Playfair Display', serif;
  font-size:1.15rem; font-weight:700;
  color: var(--white); letter-spacing:0.01em;
}
.logo-text em { color:var(--gold); font-style:normal; }
.logo-badge {
  font-family:'DM Mono', monospace;
  font-size:0.55rem; color:var(--gold); letter-spacing:0.15em;
  text-transform:uppercase; border:1px solid var(--gold-dim);
  padding:2px 6px; border-radius:2px;
  background:var(--gold-dim);
}

.header-center {
  display:flex; align-items:center; gap:24px;
}
.nav-item {
  font-size:0.72rem; color:var(--text2); cursor:pointer;
  letter-spacing:0.04em; padding:4px 0;
  border-bottom:1px solid transparent;
  transition:all .2s;
}
.nav-item:hover { color:var(--white); }
.nav-item.active { color:var(--gold); border-bottom-color:var(--gold); }

.header-right {
  display:flex; align-items:center; gap:16px;
}

.live-badge {
  display:flex; align-items:center; gap:6px;
  font-family:'DM Mono', monospace; font-size:0.65rem;
  color:var(--teal); letter-spacing:0.1em;
}
.live-pulse {
  width:6px; height:6px; border-radius:50%;
  background:var(--teal);
  box-shadow:0 0 6px var(--teal);
  animation:livepulse 2s ease-in-out infinite;
}
@keyframes livepulse {
  0%,100%{opacity:1;box-shadow:0 0 6px var(--teal);}
  50%{opacity:0.5;box-shadow:0 0 12px var(--teal),0 0 20px var(--teal);}
}

.clock-display {
  font-family:'DM Mono', monospace; font-size:0.7rem;
  color:var(--text2); letter-spacing:0.05em;
}
.clock-utc { color:var(--text3); font-size:0.6rem; margin-left:4px; }

.search-box {
  display:flex; align-items:center; gap:8px;
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border2); border-radius:6px;
  padding:5px 12px; width:180px;
  transition:border-color .2s;
}
.search-box:focus-within { border-color:var(--gold-glow); }
.search-box input {
  background:none; border:none; outline:none;
  font-family:'DM Sans', sans-serif; font-size:0.72rem;
  color:var(--white); width:100%;
}
.search-box input::placeholder { color:var(--text3); }
.search-icon { color:var(--text3); font-size:0.75rem; }

.avatar {
  width:28px; height:28px; border-radius:50%;
  background:linear-gradient(135deg, var(--gold), #e8c36a);
  display:flex; align-items:center; justify-content:center;
  font-size:0.65rem; font-weight:600; color:#000;
  cursor:pointer;
}

/* ══════════ TICKER TAPE ══════════ */
.ticker-tape {
  grid-column:1/-1;
  overflow:hidden; white-space:nowrap;
  background:rgba(7,9,14,0.7);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center;
  position:relative;
}
.ticker-tape::before,
.ticker-tape::after {
  content:''; position:absolute; top:0; bottom:0; width:60px;
  z-index:2; pointer-events:none;
}
.ticker-tape::before { left:0; background:linear-gradient(90deg,var(--bg),transparent); }
.ticker-tape::after  { right:0; background:linear-gradient(-90deg,var(--bg),transparent); }

.ticker-scroll {
  display:inline-flex; animation:tickerrun 50s linear infinite;
}
.ticker-scroll:hover { animation-play-state:paused; }
@keyframes tickerrun {
  0%{transform:translateX(0);} 100%{transform:translateX(-50%);}
}
.t-item {
  display:inline-flex; align-items:center; gap:7px;
  padding:0 22px; font-size:0.68rem;
  border-right:1px solid var(--border);
  transition:background .2s; cursor:pointer;
  height:36px;
}
.t-item:hover { background:rgba(255,255,255,0.03); }
.t-sym { font-family:'DM Mono',monospace; font-weight:500; color:var(--white); font-size:0.72rem; }
.t-price { font-family:'DM Mono',monospace; color:var(--text); }
.t-chg { font-family:'DM Mono',monospace; font-size:0.65rem; font-weight:500; }
.up-c { color:var(--up); } .dn-c { color:var(--dn); }

/* ══════════ LEFT PANEL ══════════ */
.left-panel {
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
  overflow:hidden;
  background:var(--panel);
}

.panel-head {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
}
.panel-label {
  font-family:'DM Mono',monospace; font-size:0.6rem;
  text-transform:uppercase; letter-spacing:0.12em; color:var(--text3);
}
.panel-action {
  font-size:0.65rem; color:var(--gold); cursor:pointer;
  opacity:.7; transition:opacity .2s;
}
.panel-action:hover { opacity:1; }

/* TABS */
.tabs {
  display:flex; border-bottom:1px solid var(--border);
}
.tab-btn {
  flex:1; padding:8px 0; font-family:'DM Mono',monospace;
  font-size:0.62rem; text-transform:uppercase; letter-spacing:0.08em;
  background:none; border:none; color:var(--text3);
  cursor:pointer; border-bottom:2px solid transparent;
  transition:all .2s; margin-bottom:-1px;
}
.tab-btn:hover { color:var(--text); }
.tab-btn.on { color:var(--gold); border-bottom-color:var(--gold); background:rgba(201,168,76,0.04); }

/* ASSET ROWS */
.asset-scroll { flex:1; overflow-y:auto; }
.asset-scroll::-webkit-scrollbar { width:3px; }
.asset-scroll::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.08); }

.a-row {
  display:grid; grid-template-columns:1fr auto auto;
  align-items:center; gap:0;
  padding:9px 16px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  cursor:pointer; position:relative;
  transition:background .15s;
}
.a-row::before {
  content:''; position:absolute; left:0; top:20%; bottom:20%;
  width:2px; border-radius:1px;
  background:transparent; transition:background .2s;
}
.a-row:hover { background:rgba(255,255,255,0.025); }
.a-row.sel { background:rgba(201,168,76,0.05); }
.a-row.sel::before { background:var(--gold); }

.a-info { min-width:0; }
.a-sym { font-family:'DM Mono',monospace; font-size:0.78rem; font-weight:500; color:var(--white); }
.a-name { font-size:0.62rem; color:var(--text3); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.a-spark { width:56px; padding:0 8px; }
.a-vals { text-align:right; }
.a-price { font-family:'DM Mono',monospace; font-size:0.76rem; color:var(--white); white-space:nowrap; }
.a-chg {
  display:inline-block; font-family:'DM Mono',monospace; font-size:0.62rem;
  padding:1px 5px; border-radius:3px; margin-top:2px;
}
.a-chg.up { color:var(--up); background:var(--teal-dim); }
.a-chg.dn { color:var(--dn); background:var(--red-dim); }

/* SECTION DIVIDER */
.section-div {
  padding:7px 16px;
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.14em; color:var(--text3);
  background:rgba(255,255,255,0.015);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:8px;
}
.section-div::after { content:''; flex:1; height:1px; background:var(--border); }

/* ══════════ CENTER PANEL ══════════ */
.center-panel {
  display:flex; flex-direction:column; overflow:hidden;
  position:relative;
}

/* CHART HERO */
.chart-hero {
  padding:14px 20px 10px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:flex-start; gap:0; justify-content:space-between;
  background:rgba(7,9,14,0.6);
}
.hero-left {}
.hero-sym {
  font-family:'Playfair Display', serif;
  font-size:1.5rem; font-weight:700; color:var(--white);
  line-height:1;
}
.hero-sub { font-size:0.68rem; color:var(--text3); margin-top:3px; }

.hero-price-block { display:flex; flex-direction:column; align-items:flex-end; }
.hero-price {
  font-family:'DM Mono', monospace;
  font-size:1.7rem; font-weight:500; color:var(--white);
  line-height:1; letter-spacing:-0.02em;
}
.hero-chg {
  display:flex; align-items:center; gap:8px; margin-top:4px;
}
.hero-chg-pct {
  font-family:'DM Mono',monospace; font-size:0.8rem; font-weight:500;
  padding:2px 8px; border-radius:4px;
}
.hero-chg-pct.up { color:var(--up); background:var(--teal-dim); }
.hero-chg-pct.dn { color:var(--dn); background:var(--red-dim); }
.hero-chg-abs { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--text2); }

.hero-stats {
  display:flex; gap:24px; align-items:flex-start;
}
.hs-item { text-align:center; }
.hs-label { font-size:0.58rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text3); }
.hs-val { font-family:'DM Mono',monospace; font-size:0.78rem; color:var(--white); margin-top:2px; }
.hs-val.up { color:var(--up); } .hs-val.dn { color:var(--dn); }

/* TOOLBAR */
.chart-toolbar {
  display:flex; align-items:center; justify-content:space-between;
  padding:6px 16px;
  border-bottom:1px solid var(--border);
  background:rgba(7,9,14,0.4);
}
.tf-group { display:flex; gap:2px; }
.tf {
  padding:4px 10px; font-family:'DM Mono',monospace;
  font-size:0.65rem; letter-spacing:0.06em;
  background:none; border:1px solid transparent;
  color:var(--text3); border-radius:4px; cursor:pointer;
  transition:all .18s;
}
.tf:hover { color:var(--text); background:rgba(255,255,255,0.04); }
.tf.on { color:var(--gold); border-color:rgba(201,168,76,0.3); background:rgba(201,168,76,0.06); }

.ind-group { display:flex; gap:6px; }
.ind-tag {
  padding:3px 8px; font-size:0.62rem; border-radius:3px;
  border:1px solid var(--border); color:var(--text3);
  cursor:pointer; transition:all .18s;
}
.ind-tag.on { border-color:var(--gold-dim); color:var(--gold); background:var(--gold-dim); }
.ind-tag:hover { border-color:var(--border2); }

/* CHART CONTAINER */
.chart-wrap { flex:1; position:relative; min-height:0; overflow:hidden; }
#mainChart { display:block; }

/* CROSSHAIR TOOLTIP */
.crosshair-info {
  position:absolute; top:12px; left:16px;
  background:rgba(11,17,30,0.95); border:1px solid var(--gold-dim);
  padding:8px 12px; border-radius:6px; pointer-events:none;
  font-family:'DM Mono',monospace; font-size:0.67rem;
  display:none; backdrop-filter:blur(10px);
  box-shadow:0 8px 32px rgba(0,0,0,.6);
  line-height:1.7;
}

/* OHLCV BAR */
.ohlcv-bar {
  display:flex; border-top:1px solid var(--border);
  background:rgba(7,9,14,0.7);
}
.ohlcv-item {
  flex:1; padding:7px 14px; border-right:1px solid var(--border);
  display:flex; flex-direction:column; gap:1px;
}
.ohlcv-item:last-child { border-right:none; }
.ohlcv-l { font-size:0.58rem; color:var(--text3); text-transform:uppercase; letter-spacing:0.08em; }
.ohlcv-v { font-family:'DM Mono',monospace; font-size:0.76rem; color:var(--white); }
.ohlcv-v.up { color:var(--up); } .ohlcv-v.dn { color:var(--dn); }

/* ══════════ RIGHT PANEL ══════════ */
.right-panel {
  border-left:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden;
  background:var(--panel);
}

/* ORDER BOOK */
.ob-wrap { display:flex; flex-direction:column; flex:1.2; min-height:0; overflow:hidden; }

.ob-col-headers {
  display:grid; grid-template-columns:1fr 1fr 1fr;
  padding:6px 14px;
  border-bottom:1px solid var(--border);
  background:rgba(255,255,255,0.015);
}
.ob-ch {
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.1em; color:var(--text3);
}
.ob-ch:nth-child(2) { text-align:center; }
.ob-ch:nth-child(3) { text-align:right; }

.ob-section { overflow:hidden; }
.ob-section.asks { flex:1; overflow-y:auto; display:flex; flex-direction:column; justify-content:flex-end; }
.ob-section.bids { flex:1; overflow-y:auto; }

.ob-row {
  display:grid; grid-template-columns:1fr 1fr 1fr;
  padding:3.5px 14px; position:relative; align-items:center;
  transition:background .15s; cursor:default;
}
.ob-row:hover { background:rgba(255,255,255,0.03); }
.ob-depth {
  position:absolute; top:0; bottom:0; right:0;
  transition:width .4s ease; pointer-events:none;
}
.ob-row.ask .ob-depth { background:rgba(240,93,122,0.1); }
.ob-row.bid .ob-depth { background:rgba(34,211,176,0.1); }

.ob-row span {
  font-family:'DM Mono',monospace; font-size:0.68rem;
  position:relative; z-index:1;
}
.ob-row.ask span:first-child { color:var(--dn); }
.ob-row.bid span:first-child { color:var(--up); }
.ob-row span:nth-child(2) { text-align:center; color:var(--text2); }
.ob-row span:nth-child(3) { text-align:right; color:var(--text3); }

.ob-mid {
  display:flex; align-items:center; justify-content:space-between;
  padding:5px 14px;
  border-top:1px solid var(--border); border-bottom:1px solid var(--border);
  background:rgba(201,168,76,0.05);
}
.ob-mid-price {
  font-family:'DM Mono',monospace; font-size:0.85rem;
  font-weight:500; color:var(--gold);
}
.ob-mid-spread {
  font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--text3);
}

/* RECENT TRADES */
.trades-wrap {
  flex:1; min-height:0; overflow:hidden;
  display:flex; flex-direction:column;
  border-top:1px solid var(--border);
}
.trade-item {
  display:grid; grid-template-columns:1fr 1fr 1fr;
  padding:3.5px 14px;
  border-bottom:1px solid rgba(255,255,255,0.025);
  animation:tradein .3s ease;
}
@keyframes tradein { from{opacity:0;background:rgba(255,255,255,0.06);}to{opacity:1;background:transparent;} }
.trade-item span { font-family:'DM Mono',monospace; font-size:0.67rem; }
.trade-item span:first-child.up { color:var(--up); }
.trade-item span:first-child.dn { color:var(--dn); }
.trade-item span:nth-child(2) { text-align:center; color:var(--text2); }
.trade-item span:nth-child(3) { text-align:right; color:var(--text3); }

.trades-scroll { flex:1; overflow-y:auto; }
.trades-scroll::-webkit-scrollbar { width:2px; }
.trades-scroll::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.06); }

/* ══════════ BOTTOM BAR ══════════ */
.bottom-bar {
  grid-column:1/-1;
  display:flex; align-items:stretch;
  border-top:1px solid var(--border);
  background:rgba(7,9,14,0.9);
  backdrop-filter:blur(20px);
  position:relative; overflow:hidden;
}
.bottom-bar::before {
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg, transparent 0%, var(--gold-glow) 30%, var(--teal-dim) 70%, transparent 100%);
}

.bb-item {
  flex:1; padding:0 18px;
  display:flex; flex-direction:column; justify-content:center;
  border-right:1px solid var(--border);
  gap:2px;
}
.bb-item:last-child { border-right:none; }
.bb-label {
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.1em; color:var(--text3);
}
.bb-val {
  font-family:'DM Mono',monospace; font-size:0.82rem;
  color:var(--white); font-weight:500;
}
.bb-val.up { color:var(--up); } .bb-val.dn { color:var(--dn); }
.bb-val.gold { color:var(--gold); }

.bb-pnl-bar {
  height:2px; background:var(--border); border-radius:1px;
  margin-top:2px; overflow:hidden;
}
.bb-pnl-fill {
  height:100%; border-radius:1px; transition:width .8s ease;
  background:linear-gradient(90deg, var(--teal), var(--gold));
}

/* ══════════ ALERTS TICKER ══════════ */
.alerts-strip {
  position:fixed; bottom:56px; left:0; right:0;
  pointer-events:none; z-index:50;
  display:flex; flex-direction:column; gap:4px;
  padding:0 12px 8px;
  align-items:flex-end;
}
.alert-toast {
  display:flex; align-items:center; gap:10px;
  background:rgba(11,17,30,0.95);
  border:1px solid var(--border2);
  border-left:2px solid var(--gold);
  padding:8px 14px; border-radius:6px;
  max-width:360px; pointer-events:auto;
  backdrop-filter:blur(16px);
  box-shadow:0 4px 24px rgba(0,0,0,.5);
  animation:toastin .35s cubic-bezier(.21,1.02,.73,1) both;
}
.alert-toast.up { border-left-color:var(--up); }
.alert-toast.dn { border-left-color:var(--dn); }
@keyframes toastin {
  from{opacity:0;transform:translateX(30px) scale(.96);}
  to{opacity:1;transform:none;}
}
.toast-dot {
  width:6px; height:6px; border-radius:50%; flex-shrink:0;
}
.toast-dot.gold { background:var(--gold); }
.toast-dot.up { background:var(--up); }
.toast-dot.dn { background:var(--dn); }
.toast-msg { font-size:0.67rem; color:var(--text); }
.toast-time { font-family:'DM Mono',monospace; font-size:0.58rem; color:var(--text3); margin-left:auto; padding-left:12px; white-space:nowrap; }

/* SPARKLINES */
svg.spark { overflow:visible; }

/* LOADING SCREEN */
.loader {
  position:fixed; inset:0; z-index:9000;
  background:var(--bg);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:20px;
  transition:opacity .6s, visibility .6s;
}
.loader.gone { opacity:0; visibility:hidden; }
.loader-logo {
  font-family:'Playfair Display',serif; font-size:2rem;
  font-weight:700; color:var(--white); letter-spacing:0.02em;
}
.loader-logo span { color:var(--gold); }
.loader-sub { font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--text3); letter-spacing:0.2em; text-transform:uppercase; }
.loader-track { width:240px; height:1px; background:var(--border); border-radius:1px; overflow:hidden; }
.loader-prog { height:100%; background:linear-gradient(90deg,var(--gold),var(--teal)); border-radius:1px; animation:loadprog 1.8s ease forwards; }
@keyframes loadprog { from{width:0;} to{width:100%;} }

/* SCROLLBAR GLOBAL */
::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.06); border-radius:2px; }

/* ══════════ OVERLAY VIEWS ══════════ */
.view-overlay {
  display:none;
  position:fixed;
  top:88px; /* header(52) + ticker(36) */
  left:0; right:0;
  bottom:56px; /* bottom bar */
  z-index:100;
  background:var(--bg);
  overflow-y:auto;
  animation:fadeSlideIn .22s ease both;
}
.view-overlay.active { display:block; }
@keyframes fadeSlideIn {
  from{opacity:0;transform:translateY(8px);}
  to{opacity:1;transform:none;}
}

.view-header {
  padding:20px 32px 16px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:baseline; gap:16px;
  position:sticky; top:0;
  background:rgba(7,9,14,0.97);
  backdrop-filter:blur(20px);
  z-index:10;
}
.view-title {
  font-family:'Playfair Display',serif;
  font-size:1.4rem; font-weight:700; color:var(--white);
}
.view-sub {
  font-size:0.68rem; color:var(--text3);
  font-family:'DM Mono',monospace; letter-spacing:0.06em;
}
.view-body { padding:24px 32px 40px; }

/* ── PORTFOLIO ── */
.port-grid {
  display:grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  gap:12px; margin-bottom:28px;
}
.port-card {
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px 20px;
}
.card-wide {}
.pc-label {
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.12em; color:var(--text3);
  margin-bottom:6px;
}
.pc-big {
  font-family:'DM Mono',monospace; font-size:1.5rem;
  font-weight:500; color:var(--white); line-height:1;
}
.pc-big.gold { color:var(--gold); }
.pc-big.up { color:var(--up); }
.pc-big.dn { color:var(--dn); }
.pc-sub {
  font-size:0.65rem; color:var(--text2); margin-top:4px;
}
.pc-sub.up { color:var(--up); }
.port-bar-wrap {
  height:3px; background:var(--border); border-radius:2px; margin-top:12px; overflow:hidden;
}
.port-bar-fill {
  height:100%; border-radius:2px;
  background:linear-gradient(90deg,var(--teal),var(--gold));
  transition:width 1s ease;
}
.port-section-label {
  font-family:'DM Mono',monospace; font-size:0.6rem;
  text-transform:uppercase; letter-spacing:0.14em; color:var(--text3);
  margin-bottom:10px;
}
.port-table {}
.pt-head {
  display:grid; grid-template-columns:1.2fr 0.8fr 1fr 1fr 1fr 0.8fr 1fr;
  padding:7px 14px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border); border-radius:4px 4px 0 0;
}
.pt-head span {
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.1em; color:var(--text3);
}
.pt-row {
  display:grid; grid-template-columns:1.2fr 0.8fr 1fr 1fr 1fr 0.8fr 1fr;
  padding:9px 14px;
  border:1px solid var(--border); border-top:none;
  transition:background .15s; align-items:center;
}
.pt-row:last-child { border-radius:0 0 4px 4px; }
.pt-row:hover { background:rgba(255,255,255,0.02); }
.pt-row span {
  font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--text);
}
.pt-row span.sym { color:var(--white); font-weight:500; }
.pt-row span.up { color:var(--up); }
.pt-row span.dn { color:var(--dn); }

.alloc-bars { display:flex; flex-direction:column; gap:8px; max-width:600px; }
.alloc-row { display:flex; align-items:center; gap:12px; }
.alloc-name { font-family:'DM Mono',monospace; font-size:0.68rem; color:var(--text2); width:80px; flex-shrink:0; }
.alloc-track { flex:1; height:6px; background:var(--border); border-radius:3px; overflow:hidden; }
.alloc-fill { height:100%; border-radius:3px; transition:width 1s ease; }
.alloc-pct { font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--text3); width:40px; text-align:right; }

/* ── ANALYTICS ── */
.analytics-grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px; margin-bottom:28px;
}
.an-card {
  background:var(--panel2);
  border:1px solid var(--border); border-radius:8px;
  padding:14px 18px;
}
.an-label {
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.1em; color:var(--text3);
  margin-bottom:6px;
}
.an-big {
  font-family:'DM Mono',monospace; font-size:1.3rem;
  font-weight:500; color:var(--white); line-height:1;
}
.an-big.up { color:var(--up); }
.an-big.dn { color:var(--dn); }
.an-big.gold { color:var(--gold); }
.an-sub { font-size:0.62rem; color:var(--text3); margin-top:4px; }
.an-bar-wrap { height:3px; background:var(--border); border-radius:2px; margin-top:10px; overflow:hidden; }
.an-bar-fill.up { height:100%; border-radius:2px; background:var(--up); transition:width 1.2s ease; }

.return-dist {
  display:flex; align-items:flex-end; gap:3px; height:80px;
  margin-top:8px; padding:0 4px;
}
.rd-bar {
  flex:1; border-radius:2px 2px 0 0;
  transition:height .6s ease; min-width:6px; position:relative;
}
.rd-bar.pos { background:rgba(34,211,176,0.35); }
.rd-bar.neg { background:rgba(240,93,122,0.35); }
.rd-bar:hover { filter:brightness(1.5); }

/* Trade history table for analytics */
#tradeHistoryTable .pt-row { grid-template-columns:1fr 0.6fr 1fr 1fr 1fr 1fr; }
#tradeHistoryTable + * {}

/* ── ALERTS VIEW ── */
.alerts-controls {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:16px;
}
.alert-filter-group { display:flex; gap:4px; }
.af-btn {
  padding:5px 14px; font-family:'DM Mono',monospace; font-size:0.62rem;
  text-transform:uppercase; letter-spacing:0.08em;
  background:none; border:1px solid var(--border); border-radius:4px;
  color:var(--text3); cursor:pointer; transition:all .18s;
}
.af-btn:hover { border-color:var(--border2); color:var(--text); }
.af-btn.on { border-color:rgba(201,168,76,0.4); color:var(--gold); background:var(--gold-dim); }

.alerts-feed { display:flex; flex-direction:column; gap:6px; max-height:340px; overflow-y:auto; }
.af-item {
  display:flex; align-items:center; gap:12px;
  padding:10px 16px; border-radius:6px;
  border:1px solid var(--border); background:var(--panel2);
  animation:fadeSlideIn .2s ease both;
  cursor:default; transition:background .15s;
}
.af-item:hover { background:rgba(255,255,255,0.03); }
.af-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.af-dot.up { background:var(--up); box-shadow:0 0 6px var(--up); }
.af-dot.dn { background:var(--dn); box-shadow:0 0 6px var(--dn); }
.af-dot.info { background:var(--gold); box-shadow:0 0 6px var(--gold); }
.af-type {
  font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.1em;
  padding:2px 7px; border-radius:3px; flex-shrink:0;
}
.af-type.up { color:var(--up); background:var(--teal-dim); }
.af-type.dn { color:var(--dn); background:var(--red-dim); }
.af-type.info { color:var(--gold); background:var(--gold-dim); }
.af-msg { font-size:0.72rem; color:var(--text); flex:1; }
.af-time { font-family:'DM Mono',monospace; font-size:0.6rem; color:var(--text3); flex-shrink:0; }

.alert-creator {
  display:flex; gap:8px; align-items:center; margin-top:10px; margin-bottom:14px;
}
.ac-select, .ac-input {
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border2); border-radius:5px;
  padding:7px 12px; font-family:'DM Mono',monospace; font-size:0.7rem;
  color:var(--white); outline:none;
  transition:border-color .2s;
}
.ac-select { cursor:pointer; }
.ac-select option { background:var(--bg2); }
.ac-input { width:160px; }
.ac-input:focus,.ac-select:focus { border-color:var(--gold-glow); }
.ac-btn {
  padding:7px 18px; font-family:'DM Mono',monospace; font-size:0.68rem;
  letter-spacing:0.06em; background:var(--gold-dim);
  border:1px solid rgba(201,168,76,0.4); border-radius:5px;
  color:var(--gold); cursor:pointer; transition:all .18s;
}
.ac-btn:hover { background:rgba(201,168,76,0.25); }
.custom-alerts-list { display:flex; flex-direction:column; gap:5px; }
.cal-item {
  display:flex; align-items:center; gap:10px; padding:8px 14px;
  border:1px solid var(--border); border-radius:5px; background:var(--panel2);
}
.cal-sym { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--white); font-weight:500; width:50px; }
.cal-cond { font-size:0.65rem; color:var(--text2); flex:1; }
.cal-del { font-size:0.7rem; color:var(--text3); cursor:pointer; margin-left:auto; padding:2px 6px; border-radius:3px; transition:all .15s; }
.cal-del:hover { color:var(--dn); background:var(--red-dim); }

/* ── NEWS ── */
.news-filter-group {
  display:flex; gap:4px; margin-bottom:16px;
}
.news-grid {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
}
.news-card {
  background:var(--panel2);
  border:1px solid var(--border); border-radius:8px;
  padding:16px 18px; cursor:pointer;
  transition:border-color .2s, background .2s;
  position:relative; overflow:hidden;
  animation:fadeSlideIn .25s ease both;
}
.news-card:hover { border-color:var(--border2); background:rgba(255,255,255,0.03); }
.news-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
}
.news-card.crypto::before { background:var(--gold); }
.news-card.stocks::before { background:var(--teal); }
.news-card.macro::before { background:#a78bfa; }
.news-card.forex::before { background:#60a5fa; }
.nc-tag {
  display:inline-block; font-family:'DM Mono',monospace; font-size:0.58rem;
  text-transform:uppercase; letter-spacing:0.12em;
  padding:2px 8px; border-radius:3px; margin-bottom:10px;
}
.nc-tag.crypto { color:var(--gold); background:var(--gold-dim); }
.nc-tag.stocks { color:var(--teal); background:var(--teal-dim); }
.nc-tag.macro { color:#a78bfa; background:rgba(167,139,250,0.1); }
.nc-tag.forex { color:#60a5fa; background:rgba(96,165,250,0.1); }
.nc-headline {
  font-size:0.82rem; color:var(--white); font-weight:500;
  line-height:1.45; margin-bottom:8px;
}
.nc-summary { font-size:0.68rem; color:var(--text2); line-height:1.55; margin-bottom:10px; }
.nc-footer {
  display:flex; align-items:center; justify-content:space-between;
}
.nc-source { font-family:'DM Mono',monospace; font-size:0.6rem; color:var(--text3); }
.nc-sentiment {
  font-family:'DM Mono',monospace; font-size:0.6rem;
  padding:1px 7px; border-radius:3px;
}
.nc-sentiment.bull { color:var(--up); background:var(--teal-dim); }
.nc-sentiment.bear { color:var(--dn); background:var(--red-dim); }
.nc-sentiment.neut { color:var(--text3); background:rgba(255,255,255,0.05); }
</style>
</head>
<body>

<!-- LOADER -->
<div class="loader" id="loader">
  <div class="loader-logo">Fin<span>Sight</span></div>
  <div class="loader-sub">Connecting to market feeds</div>
  <div class="loader-track"><div class="loader-prog"></div></div>
</div>

<!-- ALERTS STRIP -->
<div class="alerts-strip" id="alertsStrip"></div>

<!-- ═══ OVERLAY VIEWS ═══ -->
<div class="view-overlay" id="view-portfolio">
  <div class="view-header"><span class="view-title">Portfolio</span><span class="view-sub">Live positions & performance</span></div>
  <div class="view-body">
    <div class="port-grid">
      <div class="port-card card-wide">
        <div class="pc-label">Total Value</div>
        <div class="pc-big" id="pvTotal">$124,837.22</div>
        <div class="pc-sub up">+$2,341.88 today (+1.91%)</div>
        <div class="port-bar-wrap"><div class="port-bar-fill" style="width:72%"></div></div>
      </div>
      <div class="port-card">
        <div class="pc-label">Sharpe Ratio</div>
        <div class="pc-big gold">1.84</div>
        <div class="pc-sub">Annualized</div>
      </div>
      <div class="port-card">
        <div class="pc-label">Max Drawdown</div>
        <div class="pc-big dn">-8.3%</div>
        <div class="pc-sub">30-day peak-to-trough</div>
      </div>
      <div class="port-card">
        <div class="pc-label">Beta</div>
        <div class="pc-big">0.94</div>
        <div class="pc-sub">vs S&amp;P 500</div>
      </div>
    </div>
    <div class="port-section-label">Open Positions</div>
    <div class="port-table">
      <div class="pt-head">
        <span>Asset</span><span>Size</span><span>Entry</span><span>Current</span><span>P&amp;L</span><span>P&amp;L %</span><span>Value</span>
      </div>
      <div id="portPositions"></div>
    </div>
    <div class="port-section-label" style="margin-top:24px">Allocation</div>
    <div class="alloc-bars" id="allocBars"></div>
  </div>
</div>

<div class="view-overlay" id="view-analytics">
  <div class="view-header"><span class="view-title">Analytics</span><span class="view-sub">Performance metrics & risk analysis</span></div>
  <div class="view-body">
    <div class="analytics-grid">
      <div class="an-card">
        <div class="an-label">Win Rate</div>
        <div class="an-big up" id="anWinRate">--</div>
        <div class="an-bar-wrap"><div class="an-bar-fill up" id="anWinBar" style="width:0%"></div></div>
      </div>
      <div class="an-card">
        <div class="an-label">Profit Factor</div>
        <div class="an-big gold" id="anPF">--</div>
        <div class="an-sub">Gross profit / Gross loss</div>
      </div>
      <div class="an-card">
        <div class="an-label">Avg Win</div>
        <div class="an-big up" id="anAvgWin">--</div>
        <div class="an-sub">Per trade</div>
      </div>
      <div class="an-card">
        <div class="an-label">Avg Loss</div>
        <div class="an-big dn" id="anAvgLoss">--</div>
        <div class="an-sub">Per trade</div>
      </div>
      <div class="an-card">
        <div class="an-label">Total Trades</div>
        <div class="an-big" id="anTrades">--</div>
        <div class="an-sub">Last 30 days</div>
      </div>
      <div class="an-card">
        <div class="an-label">Alpha</div>
        <div class="an-big gold" id="anAlpha">--</div>
        <div class="an-sub">vs Benchmark</div>
      </div>
      <div class="an-card">
        <div class="an-label">Calmar Ratio</div>
        <div class="an-big" id="anCalmar">--</div>
        <div class="an-sub">Return / Max Drawdown</div>
      </div>
      <div class="an-card">
        <div class="an-label">Sortino Ratio</div>
        <div class="an-big gold" id="anSortino">--</div>
        <div class="an-sub">Downside risk adjusted</div>
      </div>
    </div>
    <div class="port-section-label" style="margin-top:20px">Trade History (Last 10)</div>
    <div class="port-table">
      <div class="pt-head"><span>Asset</span><span>Side</span><span>Entry</span><span>Exit</span><span>P&amp;L</span><span>Date</span></div>
      <div id="tradeHistoryTable"></div>
    </div>
    <div class="port-section-label" style="margin-top:20px">Return Distribution</div>
    <div id="returnDist" class="return-dist"></div>
  </div>
</div>

<div class="view-overlay" id="view-alerts">
  <div class="view-header"><span class="view-title">Alerts</span><span class="view-sub">Signal feed & price notifications</span></div>
  <div class="view-body">
    <div class="alerts-controls">
      <div class="alert-filter-group">
        <button class="af-btn on" onclick="filterAlerts('all',this)">All</button>
        <button class="af-btn" onclick="filterAlerts('up',this)">Bullish</button>
        <button class="af-btn" onclick="filterAlerts('dn',this)">Bearish</button>
        <button class="af-btn" onclick="filterAlerts('info',this)">Info</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text3)">AUTO-REFRESH</span>
        <div class="live-pulse" style="width:6px;height:6px;border-radius:50%;background:var(--teal);box-shadow:0 0 6px var(--teal);animation:livepulse 2s ease-in-out infinite"></div>
      </div>
    </div>
    <div class="alerts-feed" id="alertsFeed"></div>
    <div class="port-section-label" style="margin-top:20px">Set Price Alert</div>
    <div class="alert-creator">
      <select class="ac-select" id="alertSym">
        <option>BTC</option><option>ETH</option><option>SOL</option><option>NVDA</option><option>AAPL</option><option>TSLA</option>
      </select>
      <select class="ac-select" id="alertCond">
        <option value="above">Price Above</option>
        <option value="below">Price Below</option>
      </select>
      <input class="ac-input" id="alertPrice" type="number" placeholder="Target price…">
      <button class="ac-btn" onclick="createPriceAlert()">+ Add Alert</button>
    </div>
    <div class="custom-alerts-list" id="customAlertsList"></div>
  </div>
</div>

<div class="view-overlay" id="view-news">
  <div class="view-header"><span class="view-title">News</span><span class="view-sub">Market intelligence & events</span></div>
  <div class="view-body">
    <div class="news-filter-group">
      <button class="af-btn on" onclick="filterNews('all',this)">All</button>
      <button class="af-btn" onclick="filterNews('crypto',this)">Crypto</button>
      <button class="af-btn" onclick="filterNews('stocks',this)">Stocks</button>
      <button class="af-btn" onclick="filterNews('macro',this)">Macro</button>
      <button class="af-btn" onclick="filterNews('forex',this)">Forex</button>
    </div>
    <div class="news-grid" id="newsFeed"></div>
  </div>
</div>

<div class="app">

  <!-- ═══ HEADER ═══ -->
  <header>
    <div class="logo-mark">
      <div class="logo-icon">
        <svg viewBox="0 0 28 28" fill="none">
          <polygon points="14,2 26,22 2,22" stroke="#c9a84c" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
          <polyline points="8,22 14,10 20,22" stroke="#22d3b0" stroke-width="1.5" fill="none" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="logo-text">Fin<em>Sight</em></div>
      <div class="logo-badge">PRO</div>
    </div>

    <div class="header-center">
      <span class="nav-item active" onclick="switchView('markets',this)">Markets</span>
      <span class="nav-item" onclick="switchView('portfolio',this)">Portfolio</span>
      <span class="nav-item" onclick="switchView('analytics',this)">Analytics</span>
      <span class="nav-item" onclick="switchView('alerts',this)">Alerts</span>
      <span class="nav-item" onclick="switchView('news',this)">News</span>
    </div>

    <div class="header-right">
      <div class="live-badge"><div class="live-pulse"></div>LIVE FEED</div>
      <div class="clock-display" id="clock">--:--:--<span class="clock-utc">UTC</span></div>
      <div class="search-box">
        <span class="search-icon">⌕</span>
        <input id="searchInput" placeholder="Symbol or name…" autocomplete="off">
      </div>
      <div class="avatar">JD</div>
    </div>
  </header>

  <!-- ═══ TICKER ═══ -->
  <div class="ticker-tape">
    <div class="ticker-scroll" id="tickerScroll"></div>
  </div>

  <!-- ═══ LEFT PANEL ═══ -->
  <div class="left-panel">
    <div class="tabs">
      <button class="tab-btn on" onclick="switchTab('crypto',this)">Crypto</button>
      <button class="tab-btn" onclick="switchTab('stocks',this)">Stocks</button>
      <button class="tab-btn" onclick="switchTab('forex',this)">Forex</button>
    </div>
    <div class="asset-scroll" id="assetList"></div>
  </div>

  <!-- ═══ CENTER PANEL ═══ -->
  <div class="center-panel">
    <div class="chart-hero">
      <div class="hero-left">
        <div class="hero-sym" id="heroSym">BTC/USD</div>
        <div class="hero-sub" id="heroSub">Bitcoin · Crypto · NYSE</div>
      </div>
      <div class="hero-stats">
        <div class="hs-item">
          <div class="hs-label">24H High</div>
          <div class="hs-val up" id="hsHigh">--</div>
        </div>
        <div class="hs-item">
          <div class="hs-label">24H Low</div>
          <div class="hs-val dn" id="hsLow">--</div>
        </div>
        <div class="hs-item">
          <div class="hs-label">Volume</div>
          <div class="hs-val" id="hsVol">--</div>
        </div>
        <div class="hs-item">
          <div class="hs-label">Mkt Cap</div>
          <div class="hs-val" id="hsMcap">--</div>
        </div>
      </div>
      <div class="hero-price-block">
        <div class="hero-price" id="heroPrice">--</div>
        <div class="hero-chg">
          <span class="hero-chg-pct up" id="heroChgPct">--</span>
          <span class="hero-chg-abs" id="heroChgAbs">--</span>
        </div>
      </div>
    </div>

    <div class="chart-toolbar">
      <div class="tf-group" id="tfGroup">
        <button class="tf" onclick="setTF('1m',this)">1M</button>
        <button class="tf" onclick="setTF('5m',this)">5M</button>
        <button class="tf on" onclick="setTF('1h',this)">1H</button>
        <button class="tf" onclick="setTF('4h',this)">4H</button>
        <button class="tf" onclick="setTF('1d',this)">1D</button>
        <button class="tf" onclick="setTF('1w',this)">1W</button>
      </div>
      <div class="ind-group">
        <span class="ind-tag on" onclick="toggleInd(this,'ma')">MA20</span>
        <span class="ind-tag on" onclick="toggleInd(this,'ema')">EMA50</span>
        <span class="ind-tag" onclick="toggleInd(this,'bb')">BB</span>
        <span class="ind-tag" onclick="toggleInd(this,'vol')">VOL</span>
      </div>
    </div>

    <div class="chart-wrap" id="chartWrap">
      <svg id="mainChart"></svg>
      <div class="crosshair-info" id="crosshairInfo"></div>
    </div>

    <div class="ohlcv-bar">
      <div class="ohlcv-item"><div class="ohlcv-l">Open</div><div class="ohlcv-v" id="ovOpen">--</div></div>
      <div class="ohlcv-item"><div class="ohlcv-l">High</div><div class="ohlcv-v up" id="ovHigh">--</div></div>
      <div class="ohlcv-item"><div class="ohlcv-l">Low</div><div class="ohlcv-v dn" id="ovLow">--</div></div>
      <div class="ohlcv-item"><div class="ohlcv-l">Close</div><div class="ohlcv-v" id="ovClose">--</div></div>
      <div class="ohlcv-item"><div class="ohlcv-l">Volume (24H)</div><div class="ohlcv-v" id="ovVol">--</div></div>
      <div class="ohlcv-item"><div class="ohlcv-l">Vwap</div><div class="ohlcv-v" id="ovVwap">--</div></div>
    </div>
  </div>

  <!-- ═══ RIGHT PANEL ═══ -->
  <div class="right-panel">
    <div class="panel-head"><span class="panel-label">Order Book</span><span class="panel-action">Depth</span></div>

    <div class="ob-col-headers">
      <span class="ob-ch">Price</span>
      <span class="ob-ch" style="text-align:center">Size</span>
      <span class="ob-ch" style="text-align:right">Total</span>
    </div>

    <div class="ob-wrap">
      <div class="ob-section asks" id="askSection"></div>
      <div class="ob-mid">
        <span class="ob-mid-price" id="obMidPrice">--</span>
        <span class="ob-mid-spread" id="obSpread">Spread --</span>
      </div>
      <div class="ob-section bids" id="bidSection"></div>
    </div>

    <div class="trades-wrap">
      <div class="panel-head" style="flex-shrink:0"><span class="panel-label">Recent Trades</span></div>
      <div class="ob-col-headers" style="flex-shrink:0">
        <span class="ob-ch">Price</span>
        <span class="ob-ch" style="text-align:center">Size</span>
        <span class="ob-ch" style="text-align:right">Time</span>
      </div>
      <div class="trades-scroll" id="tradesList"></div>
    </div>
  </div>

  <!-- ═══ BOTTOM BAR ═══ -->
  <div class="bottom-bar">
    <div class="bb-item">
      <div class="bb-label">Portfolio Value</div>
      <div class="bb-val" id="bbVal">$0.00</div>
    </div>
    <div class="bb-item">
      <div class="bb-label">Day P&amp;L</div>
      <div class="bb-val up" id="bbPnl">+$0.00</div>
      <div class="bb-pnl-bar"><div class="bb-pnl-fill" id="bbPnlBar" style="width:60%"></div></div>
    </div>
    <div class="bb-item">
      <div class="bb-label">Sharpe Ratio</div>
      <div class="bb-val gold" id="bbSharpe">1.84</div>
    </div>
    <div class="bb-item">
      <div class="bb-label">Max Drawdown</div>
      <div class="bb-val dn">-8.3%</div>
    </div>
    <div class="bb-item">
      <div class="bb-label">Beta</div>
      <div class="bb-val">0.94</div>
    </div>
    <div class="bb-item">
      <div class="bb-label">Positions</div>
      <div class="bb-val">7 open</div>
    </div>
    <div class="bb-item">
      <div class="bb-label">Risk Level</div>
      <div class="bb-val dn">HIGH · 62%</div>
    </div>
    <div class="bb-item">
      <div class="bb-label">VIX</div>
      <div class="bb-val" id="bbVix">18.42</div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════
//  DATA
// ══════════════════════════════════════════
const DATA = {
  crypto:[
    {sym:'BTC',name:'Bitcoin',price:67420,chg:2.84,mcap:'$1.32T',vol:'38.2B'},
    {sym:'ETH',name:'Ethereum',price:3512.4,chg:1.72,mcap:'$421B',vol:'18.6B'},
    {sym:'SOL',name:'Solana',price:168.30,chg:4.12,mcap:'$72B',vol:'4.1B'},
    {sym:'BNB',name:'Binance Coin',price:573.20,chg:-0.95,mcap:'$85B',vol:'2.3B'},
    {sym:'AVAX',name:'Avalanche',price:38.74,chg:-1.22,mcap:'$15B',vol:'0.9B'},
    {sym:'LINK',name:'Chainlink',price:17.40,chg:2.08,mcap:'$10B',vol:'0.7B'},
    {sym:'DOT',name:'Polkadot',price:8.23,chg:-0.67,mcap:'$11B',vol:'0.5B'},
    {sym:'MATIC',name:'Polygon',price:0.9812,chg:3.44,mcap:'$9B',vol:'0.4B'},
  ],
  stocks:[
    {sym:'NVDA',name:'NVIDIA Corp.',price:876.40,chg:4.55,mcap:'$2.15T',vol:'22.1B'},
    {sym:'AAPL',name:'Apple Inc.',price:185.42,chg:1.24,mcap:'$2.87T',vol:'9.4B'},
    {sym:'MSFT',name:'Microsoft Corp.',price:415.22,chg:0.88,mcap:'$3.1T',vol:'7.2B'},
    {sym:'TSLA',name:'Tesla Inc.',price:248.50,chg:-3.12,mcap:'$790B',vol:'15.3B'},
    {sym:'META',name:'Meta Platforms',price:502.10,chg:2.33,mcap:'$1.28T',vol:'6.8B'},
    {sym:'AMZN',name:'Amazon.com',price:182.30,chg:-1.05,mcap:'$1.89T',vol:'8.1B'},
    {sym:'GOOGL',name:'Alphabet Inc.',price:175.80,chg:0.61,mcap:'$2.2T',vol:'5.4B'},
    {sym:'AMD',name:'Adv. Micro Devices',price:168.90,chg:3.20,mcap:'$272B',vol:'4.9B'},
  ],
  forex:[
    {sym:'EUR/USD',name:'Euro / US Dollar',price:1.0842,chg:0.12,mcap:'—',vol:'$3.2T'},
    {sym:'GBP/USD',name:'British Pound / USD',price:1.2658,chg:-0.08,mcap:'—',vol:'$1.6T'},
    {sym:'USD/JPY',name:'USD / Japanese Yen',price:149.82,chg:0.35,mcap:'—',vol:'$1.1T'},
    {sym:'AUD/USD',name:'Australian Dollar / USD',price:0.6512,chg:-0.22,mcap:'—',vol:'$0.5T'},
    {sym:'USD/CAD',name:'USD / Canadian Dollar',price:1.3680,chg:0.15,mcap:'—',vol:'$0.4T'},
    {sym:'USD/CHF',name:'USD / Swiss Franc',price:0.8960,chg:-0.10,mcap:'—',vol:'$0.3T'},
  ]
};

let curTab = 'crypto';
let curAsset = DATA.crypto[0];
let curTF = '1h';
let candles = [];
let inds = {ma:true, ema:true, bb:false, vol:true};

// ══════════════════════════════════════════
//  UTILITIES
// ══════════════════════════════════════════
const prec = p => p<0.001?6:p<0.01?5:p<1?4:p<100?3:2;
const fmt  = p => p.toLocaleString(undefined,{minimumFractionDigits:prec(p),maximumFractionDigits:prec(p)});
const fmtSm= p => '$'+fmt(p);

function randomWalk(p, vol=0.0018) {
  return Math.max(p*(1+(Math.random()-.48)*vol), 0.00001);
}

// ══════════════════════════════════════════
//  CLOCK
// ══════════════════════════════════════════
function updateClock() {
  const n=new Date();
  const pad=x=>String(x).padStart(2,'0');
  document.getElementById('clock').innerHTML =
    `${pad(n.getUTCHours())}:${pad(n.getUTCMinutes())}:${pad(n.getUTCSeconds())}<span class="clock-utc"> UTC</span>`;
}
setInterval(updateClock,1000); updateClock();

// ══════════════════════════════════════════
//  TICKER
// ══════════════════════════════════════════
function renderTicker() {
  const all=[...DATA.stocks.slice(0,6),...DATA.crypto.slice(0,5),...DATA.forex.slice(0,3)];
  const html=all.map(a=>{
    const up=a.chg>=0;
    const arrow=up?'▲':'▼';
    return `<div class="t-item" onclick="jumpToAsset('${a.sym}')">
      <span class="t-sym">${a.sym}</span>
      <span class="t-price">${fmtSm(a.price)}</span>
      <span class="t-chg ${up?'up-c':'dn-c'}">${arrow} ${Math.abs(a.chg).toFixed(2)}%</span>
    </div>`;
  }).join('');
  const el=document.getElementById('tickerScroll');
  el.innerHTML=html+html;
}

// ══════════════════════════════════════════
//  PRICE SIMULATION
// ══════════════════════════════════════════
function tickPrices() {
  Object.values(DATA).flat().forEach(a => {
    const prev = a.price;
    a.price = +randomWalk(a.price).toFixed(prec(a.price));
    const delta = (a.price-prev)/prev*100;
    a.chg = +(a.chg*0.998 + delta*0.3).toFixed(3);
    a.chg = Math.max(-25, Math.min(25, a.chg));
  });
  if(curAsset) {
    const found = Object.values(DATA).flat().find(a=>a.sym===curAsset.sym);
    if(found) curAsset = found;
  }
}

// ══════════════════════════════════════════
//  ASSET LIST
// ══════════════════════════════════════════
function switchTab(tab, el) {
  curTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  renderAssetList();
}

function renderAssetList() {
  const list = DATA[curTab];
  document.getElementById('assetList').innerHTML = list.map(a => {
    const up = a.chg >= 0;
    const sparkSVG = miniSpark(a);
    return `<div class="a-row ${a.sym===curAsset.sym?'sel':''}" onclick="selectAsset('${curTab}','${a.sym}')">
      <div class="a-info">
        <div class="a-sym">${a.sym}</div>
        <div class="a-name">${a.name}</div>
      </div>
      <div class="a-spark">${sparkSVG}</div>
      <div class="a-vals">
        <div class="a-price">${fmtSm(a.price)}</div>
        <div class="a-chg ${up?'up':'dn'}">${up?'+':''}${a.chg.toFixed(2)}%</div>
      </div>
    </div>`;
  }).join('');
}

function miniSpark(asset) {
  const pts=[]; let p=asset.price*0.97;
  for(let i=0;i<30;i++){p=randomWalk(p,0.004);pts.push(p);}
  const mn=Math.min(...pts),mx=Math.max(...pts),r=mx-mn||1;
  const W=48,H=20;
  const coords=pts.map((v,i)=>[(i/(pts.length-1))*W, H-((v-mn)/r)*H]);
  const d=coords.map((c,i)=>`${i?'L':'M'}${c[0].toFixed(1)},${c[1].toFixed(1)}`).join(' ');
  const col=asset.chg>=0?'#22d3b0':'#f05d7a';
  const last=coords[coords.length-1];
  return `<svg class="spark" width="${W}" height="${H}">
    <path d="${d}" fill="none" stroke="${col}" stroke-width="1.4" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${last[0]}" cy="${last[1]}" r="2" fill="${col}"/>
  </svg>`;
}

function selectAsset(tab, sym) {
  const a = DATA[tab]?.find(x=>x.sym===sym);
  if(!a) return;
  curAsset = a; curTab = tab;
  generateCandles();
  renderAssetList();
  renderHero();
  drawChart();
  renderOrderBook();
}

function jumpToAsset(sym) {
  for(const [tab,list] of Object.entries(DATA)) {
    const found = list.find(a=>a.sym===sym);
    if(found) { selectAsset(tab,sym); break; }
  }
}

// ══════════════════════════════════════════
//  HERO BAR
// ══════════════════════════════════════════
function renderHero() {
  const a = curAsset;
  const up = a.chg >= 0;
  document.getElementById('heroSym').textContent  = a.sym + (curTab!=='forex'?'/USD':'');
  document.getElementById('heroSub').textContent  = a.name + ' · ' + curTab.charAt(0).toUpperCase()+curTab.slice(1);
  document.getElementById('heroPrice').textContent = fmtSm(a.price);

  const pct = document.getElementById('heroChgPct');
  pct.textContent = (up?'+':'')+a.chg.toFixed(2)+'%';
  pct.className = 'hero-chg-pct '+(up?'up':'dn');

  const abs = a.price * Math.abs(a.chg)/100;
  document.getElementById('heroChgAbs').textContent = (up?'+':'-')+'$'+fmt(abs);

  if(candles.length) {
    const highs=candles.map(c=>c.h), lows=candles.map(c=>c.l);
    const vol=candles.reduce((s,c)=>s+c.v,0);
    document.getElementById('hsHigh').textContent  = fmtSm(Math.max(...highs));
    document.getElementById('hsLow').textContent   = fmtSm(Math.min(...lows));
    document.getElementById('hsVol').textContent   = (vol/1e6).toFixed(1)+'M';
    document.getElementById('hsMcap').textContent  = a.mcap||'N/A';
  }
}

// ══════════════════════════════════════════
//  CANDLE GENERATION
// ══════════════════════════════════════════
const TF_MS = {'1m':60e3,'5m':300e3,'1h':3600e3,'4h':14400e3,'1d':86400e3,'1w':604800e3};

function generateCandles(n=90) {
  candles = [];
  let price = curAsset.price * (0.88 + Math.random()*0.06);
  const now = Date.now();
  const step = TF_MS[curTF]||3600e3;
  for(let i=n;i>=0;i--) {
    const open  = price;
    const sign  = Math.random()>.44?1:-1;
    const range = price * 0.016;
    const close = price + sign*Math.random()*range;
    const high  = Math.max(open,close)+Math.random()*range*.6;
    const low   = Math.min(open,close)-Math.random()*range*.6;
    candles.push({
      t:new Date(now-i*step),
      o:+open.toFixed(prec(open)), h:+high.toFixed(prec(open)),
      l:+low.toFixed(prec(open)),  c:+close.toFixed(prec(open)),
      v:Math.floor(Math.random()*80000+15000)
    });
    price = close;
  }
  // align last candle
  const last = candles[candles.length-1];
  last.c = curAsset.price;
  last.h = Math.max(last.h, last.c);
  last.l = Math.min(last.l, last.c);
  updateOHLCV();
}

function updateOHLCV() {
  if(!candles.length) return;
  const first=candles[0], last=candles[candles.length-1];
  const allH=candles.map(c=>c.h), allL=candles.map(c=>c.l);
  const vol=candles.reduce((s,c)=>s+c.v,0);
  const vwap = candles.reduce((s,c)=>s+(c.h+c.l+c.c)/3*c.v,0)/vol;
  document.getElementById('ovOpen').textContent  = fmtSm(first.o);
  document.getElementById('ovHigh').textContent  = fmtSm(Math.max(...allH));
  document.getElementById('ovLow').textContent   = fmtSm(Math.min(...allL));
  document.getElementById('ovClose').textContent = fmtSm(last.c);
  document.getElementById('ovVol').textContent   = (vol/1e6).toFixed(2)+'M';
  document.getElementById('ovVwap').textContent  = fmtSm(vwap);
}

function setTF(tf, el) {
  curTF = tf;
  document.querySelectorAll('.tf').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  generateCandles();
  drawChart();
}

function toggleInd(el, key) {
  inds[key] = !inds[key];
  el.classList.toggle('on', inds[key]);
  drawChart();
}

// ══════════════════════════════════════════
//  CHART
// ══════════════════════════════════════════
function drawChart() {
  const wrap = document.getElementById('chartWrap');
  const W = wrap.clientWidth, H = wrap.clientHeight;
  if(W<=0||H<=0) return;

  const svg = d3.select('#mainChart').attr('width',W).attr('height',H);
  svg.selectAll('*').remove();

  const mg = {top:12, right:72, bottom:34, left:12};
  const cw = W - mg.left - mg.right;
  const ch = H - mg.top - mg.bottom;
  const volH = inds.vol ? ch*0.15 : 0;
  const chartH = ch - volH - (volH>0?8:0);

  const n = candles.length;
  const xBand = d3.scaleBand().domain(d3.range(n)).range([0,cw]).padding(0.25);
  const priceMin = d3.min(candles,d=>d.l)*0.9985;
  const priceMax = d3.max(candles,d=>d.h)*1.0015;
  const yP = d3.scaleLinear().domain([priceMin,priceMax]).range([chartH,0]);

  const g = svg.append('g').attr('transform',`translate(${mg.left},${mg.top})`);

  // ── GRADIENT DEFS ──
  const defs = svg.append('defs');

  // Bullish area gradient
  const gradUp = defs.append('linearGradient').attr('id','gradUp').attr('x1',0).attr('y1',0).attr('x2',0).attr('y2',1);
  gradUp.append('stop').attr('offset','0%').attr('stop-color','#22d3b0').attr('stop-opacity',.18);
  gradUp.append('stop').attr('offset','100%').attr('stop-color','#22d3b0').attr('stop-opacity',0);

  // Area path (close prices)
  const areaPath = d3.area()
    .x((d,i)=>xBand(i)+xBand.bandwidth()/2)
    .y0(chartH).y1(d=>yP(d.c))
    .curve(d3.curveMonotoneX);

  g.append('path').datum(candles)
    .attr('fill','url(#gradUp)').attr('d',areaPath).attr('opacity',0.6);

  // ── GRID ──
  const yTicks = yP.ticks(7);
  g.selectAll('.gy').data(yTicks).enter().append('line').attr('class','gy')
    .attr('x1',0).attr('x2',cw)
    .attr('y1',d=>yP(d)).attr('y2',d=>yP(d))
    .attr('stroke','rgba(255,255,255,0.04)').attr('stroke-width',1);

  // ── Y AXIS ──
  const yAxisG = svg.append('g').attr('transform',`translate(${mg.left+cw},${mg.top})`);
  yAxisG.selectAll('.yl').data(yTicks).enter().append('text').attr('class','yl')
    .attr('x',8).attr('y',d=>yP(d)+4)
    .attr('fill','rgba(136,152,170,0.7)').attr('font-size','10px')
    .attr('font-family','DM Mono, monospace')
    .text(d=>d>=1000?'$'+d3.format(',.0f')(d):'$'+d.toFixed(prec(d)));

  // ── VOLUME ──
  if(inds.vol && volH>0) {
    const vy0 = chartH+8;
    const maxV = d3.max(candles,d=>d.v);
    const vS = d3.scaleLinear().domain([0,maxV]).range([0,volH]);
    g.selectAll('.vb').data(candles).enter().append('rect').attr('class','vb')
      .attr('x',(d,i)=>xBand(i)).attr('width',xBand.bandwidth())
      .attr('y',(d,i)=>vy0+volH-vS(d.v)).attr('height',(d,i)=>vS(d.v))
      .attr('fill',d=>d.c>=d.o?'rgba(34,211,176,0.22)':'rgba(240,93,122,0.22)')
      .attr('rx',1);
  }

  // ── MA20 ──
  if(inds.ma && n>=20) {
    const ma = candles.map((d,i,arr)=>i<19?null:{i,v:d3.mean(arr.slice(i-19,i+1),d=>d.c)}).filter(Boolean);
    const maL = d3.line().x(d=>xBand(d.i)+xBand.bandwidth()/2).y(d=>yP(d.v));
    g.append('path').datum(ma).attr('fill','none')
      .attr('stroke','#c9a84c').attr('stroke-width',1.2).attr('stroke-dasharray','3,3').attr('opacity',.75)
      .attr('d',maL);
  }

  // ── EMA50 ──
  if(inds.ema && n>=20) {
    const k=2/(Math.min(50,n)+1);
    let ema=candles[0].c;
    const emas=candles.map((d,i)=>{ ema=d.c*k+ema*(1-k); return {i,v:ema}; });
    const eL = d3.line().x(d=>xBand(d.i)+xBand.bandwidth()/2).y(d=>yP(d.v));
    g.append('path').datum(emas).attr('fill','none')
      .attr('stroke','#8b5cf6').attr('stroke-width',1.2).attr('stroke-dasharray','5,3').attr('opacity',.7)
      .attr('d',eL);
  }

  // ── BOLLINGER BANDS ──
  if(inds.bb && n>=20) {
    const bb = candles.map((d,i,arr)=>{
      if(i<19) return null;
      const sl=arr.slice(i-19,i+1).map(x=>x.c);
      const m=d3.mean(sl), s=d3.deviation(sl);
      return {i, up:m+2*s, dn:m-2*s, mid:m};
    }).filter(Boolean);
    const bbUp=d3.line().x(d=>xBand(d.i)+xBand.bandwidth()/2).y(d=>yP(d.up));
    const bbDn=d3.line().x(d=>xBand(d.i)+xBand.bandwidth()/2).y(d=>yP(d.dn));
    g.append('path').datum(bb).attr('fill','none').attr('stroke','rgba(139,92,246,0.4)').attr('stroke-width',1).attr('d',bbUp);
    g.append('path').datum(bb).attr('fill','none').attr('stroke','rgba(139,92,246,0.4)').attr('stroke-width',1).attr('d',bbDn);
  }

  // ── CANDLES ──
  const cg = g.selectAll('.c').data(candles).enter().append('g').attr('class','c');

  // Wicks
  cg.append('line')
    .attr('x1',(d,i)=>xBand(i)+xBand.bandwidth()/2)
    .attr('x2',(d,i)=>xBand(i)+xBand.bandwidth()/2)
    .attr('y1',d=>yP(d.h)).attr('y2',d=>yP(d.l))
    .attr('stroke',d=>d.c>=d.o?'rgba(34,211,176,0.8)':'rgba(240,93,122,0.8)')
    .attr('stroke-width',1);

  // Bodies
  cg.append('rect')
    .attr('x',(d,i)=>xBand(i)).attr('width',xBand.bandwidth())
    .attr('y',d=>yP(Math.max(d.o,d.c)))
    .attr('height',d=>Math.max(1,Math.abs(yP(d.o)-yP(d.c))))
    .attr('fill',d=>d.c>=d.o?'#22d3b0':'#f05d7a')
    .attr('rx',1.5)
    .attr('opacity',d=>d===candles[candles.length-1]?1:0.85);

  // Last price line
  const lastP = candles[candles.length-1].c;
  const lastY = yP(lastP);
  g.append('line')
    .attr('x1',0).attr('x2',cw)
    .attr('y1',lastY).attr('y2',lastY)
    .attr('stroke','rgba(201,168,76,0.45)')
    .attr('stroke-width',1).attr('stroke-dasharray','4,4');
  yAxisG.append('rect').attr('x',2).attr('y',lastY-9).attr('width',64).attr('height',18).attr('rx',3).attr('fill','#c9a84c');
  yAxisG.append('text').attr('x',34).attr('y',lastY+4).attr('text-anchor','middle')
    .attr('fill','#000').attr('font-size','9px').attr('font-family','DM Mono, monospace').attr('font-weight','500')
    .text('$'+fmt(lastP));

  // ── X AXIS ──
  const tfFmt = {'1m':'%H:%M','5m':'%H:%M','1h':'%d %b %H:%M','4h':'%d %b','1d':'%d %b','1w':'%d %b %Y'};
  const xFmt = d3.timeFormat(tfFmt[curTF]||'%H:%M');
  const step = Math.max(1,Math.floor(n/6));
  candles.forEach((d,i)=>{
    if(i%step===0||i===n-1) {
      g.append('text').attr('x',xBand(i)+xBand.bandwidth()/2).attr('y',ch+20)
        .attr('text-anchor','middle').attr('fill','rgba(136,152,170,0.6)')
        .attr('font-size','9px').attr('font-family','DM Mono, monospace').text(xFmt(d.t));
    }
  });

  // ── CROSSHAIR ──
  const crossV = g.append('line').attr('y1',0).attr('y2',chartH).attr('stroke','rgba(255,255,255,0.15)').attr('stroke-width',1).attr('display','none');
  const crossH = g.append('line').attr('x1',0).attr('x2',cw).attr('stroke','rgba(255,255,255,0.15)').attr('stroke-width',1).attr('display','none');
  const info = document.getElementById('crosshairInfo');

  svg.append('rect').attr('width',W).attr('height',H).attr('fill','transparent')
    .on('mousemove', function(ev) {
      const [mx,my] = d3.pointer(ev);
      const rx = mx - mg.left;
      const idx = Math.round(rx/xBand.step());
      if(idx<0||idx>=n){ info.style.display='none'; crossV.attr('display','none'); crossH.attr('display','none'); return; }
      const d = candles[idx];
      crossV.attr('display',null).attr('x1',xBand(idx)+xBand.bandwidth()/2).attr('x2',xBand(idx)+xBand.bandwidth()/2);
      crossH.attr('display',null).attr('y1',my-mg.top).attr('y2',my-mg.top);
      info.style.display='block';
      const up=d.c>=d.o;
      info.innerHTML=`<span style="color:${up?'#22d3b0':'#f05d7a'};font-weight:500">${d3.timeFormat('%a %d %b %Y %H:%M')(d.t)}</span><br>
        <span style="color:#8898aa">O</span> <b>${fmtSm(d.o)}</b>&nbsp;&nbsp;
        <span style="color:#22d3b0">H</span> <b>${fmtSm(d.h)}</b>&nbsp;&nbsp;
        <span style="color:#f05d7a">L</span> <b>${fmtSm(d.l)}</b>&nbsp;&nbsp;
        <span style="color:#8898aa">C</span> <b>${fmtSm(d.c)}</b><br>
        <span style="color:#3d5068">Vol</span> <span style="color:#8898aa">${d.v.toLocaleString()}</span>`;
    })
    .on('mouseleave',()=>{ info.style.display='none'; crossV.attr('display','none'); crossH.attr('display','none'); });
}

// ══════════════════════════════════════════
//  ORDER BOOK
// ══════════════════════════════════════════
function renderOrderBook() {
  const price = curAsset.price;
  const asks=[], bids=[];
  let ap = price*1.0001, bp = price*0.9999;
  for(let i=0;i<10;i++){
    const sz = +(Math.random()*8+0.2).toFixed(3);
    asks.push({p:+ap.toFixed(prec(price)),s:sz,t:(ap*sz).toFixed(2)});
    ap *= 1.00025;
  }
  for(let i=0;i<10;i++){
    const sz = +(Math.random()*8+0.2).toFixed(3);
    bids.push({p:+bp.toFixed(prec(price)),s:sz,t:(bp*sz).toFixed(2)});
    bp *= 0.99975;
  }
  asks.reverse();
  const maxSz = Math.max(...asks.map(a=>a.s),...bids.map(b=>b.s));

  const mkRow = (r,cls) => {
    const pct=(r.s/maxSz*100).toFixed(1);
    return `<div class="ob-row ${cls}">
      <div class="ob-depth" style="width:${pct}%"></div>
      <span>${fmtSm(r.p)}</span>
      <span>${r.s}</span>
      <span>${Number(r.t).toLocaleString()}</span>
    </div>`;
  };

  document.getElementById('askSection').innerHTML = asks.map(r=>mkRow(r,'ask')).join('');
  document.getElementById('bidSection').innerHTML = bids.map(r=>mkRow(r,'bid')).join('');
  document.getElementById('obMidPrice').textContent = fmtSm(price);
  const spread = (asks[asks.length-1].p - bids[0].p);
  document.getElementById('obSpread').textContent = `Spread ${fmt(spread)} (${(spread/price*100).toFixed(3)}%)`;
}

// ══════════════════════════════════════════
//  RECENT TRADES
// ══════════════════════════════════════════
let tradeHistory = [];
function addTrade() {
  const price = curAsset.price * (1 + (Math.random()-.5)*0.001);
  const sz = +(Math.random()*3+0.05).toFixed(3);
  const up = Math.random() > 0.45;
  const now = new Date();
  const pad = x=>String(x).padStart(2,'0');
  const time = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  tradeHistory.unshift({price:+price.toFixed(prec(curAsset.price)),sz,up,time});
  if(tradeHistory.length>30) tradeHistory.pop();
  const container = document.getElementById('tradesList');
  container.innerHTML = tradeHistory.map(t=>`
    <div class="trade-item">
      <span class="${t.up?'up':'dn'}" style="color:${t.up?'#22d3b0':'#f05d7a'}">${fmtSm(t.price)}</span>
      <span>${t.sz}</span>
      <span>${t.time}</span>
    </div>`).join('');
}

// ══════════════════════════════════════════
//  PORTFOLIO BAR
// ══════════════════════════════════════════
let pfBase = 124837.22, pnlBase = 2341.88;
function updatePortfolio() {
  pfBase += (Math.random()-.48)*120;
  pnlBase += (Math.random()-.48)*80;
  const up = pnlBase >= 0;
  document.getElementById('bbVal').textContent = '$'+pfBase.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const pnlEl = document.getElementById('bbPnl');
  pnlEl.textContent = (up?'+':'')+pnlBase.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2,style:'currency',currency:'USD'});
  pnlEl.className = 'bb-val '+(up?'up':'dn');
  document.getElementById('bbPnlBar').style.width = Math.min(100,Math.abs(pnlBase)/50)+'%';
  const vix = (18.42 + (Math.random()-.5)*0.3).toFixed(2);
  document.getElementById('bbVix').textContent = vix;
}

// ══════════════════════════════════════════
//  ALERTS
// ══════════════════════════════════════════
const ALERT_TEMPLATES = [
  a=>({type:'up',  msg:`${a.sym} broke above $${fmt(a.price*1.008)} resistance`}),
  a=>({type:'dn',  msg:`${a.sym} RSI crossed 72 — overbought signal`}),
  a=>({type:'info',msg:`${a.sym} volume ${(Math.random()*3.5+1.5).toFixed(1)}× 30-day average`}),
  a=>({type:'up',  msg:`${a.sym} MACD bullish crossover on ${curTF}`}),
  a=>({type:'dn',  msg:`${a.sym} approaching key support — watch closely`}),
  a=>({type:'info',msg:`Whale alert: ${(Math.random()*400+100).toFixed(0)} ${a.sym} moved on-chain`}),
  a=>({type:'up',  msg:`${a.sym} +${(Math.random()*2+0.5).toFixed(2)}% surge in last 5 min`}),
  a=>({type:'info',msg:`Options flow: heavy ${a.sym} call buying detected`}),
];

let toastQueue = [];
function pushAlert() {
  const all = Object.values(DATA).flat();
  const asset = all[Math.floor(Math.random()*all.length)];
  const tmpl = ALERT_TEMPLATES[Math.floor(Math.random()*ALERT_TEMPLATES.length)];
  const {type, msg} = tmpl(asset);
  const strip = document.getElementById('alertsStrip');

  // cap at 3 toasts
  if(strip.children.length >= 3) strip.lastChild?.remove();

  const now = new Date();
  const time = now.toLocaleTimeString();
  const toast = document.createElement('div');
  toast.className = `alert-toast ${type}`;
  toast.innerHTML = `<div class="toast-dot ${type==='info'?'gold':type}"></div>
    <span class="toast-msg">${msg}</span>
    <span class="toast-time">${time}</span>`;
  toast.onclick = () => { toast.style.opacity='0'; setTimeout(()=>toast.remove(),300); };
  strip.prepend(toast);
  storeAlert(type, msg);
  setTimeout(()=>{ toast.style.transition='opacity .4s'; toast.style.opacity='0'; setTimeout(()=>toast.remove(),400); }, 7000);
}

// ══════════════════════════════════════════
//  SEARCH
// ══════════════════════════════════════════
document.getElementById('searchInput').addEventListener('input', function() {
  const q = this.value.trim().toUpperCase();
  if(!q) return;
  const all = Object.values(DATA).flat();
  const match = all.find(a=>a.sym===q||a.sym.startsWith(q)||a.name.toUpperCase().includes(q));
  if(match) {
    for(const [tab,list] of Object.entries(DATA)) {
      if(list.find(x=>x.sym===match.sym)) { selectAsset(tab,match.sym); break; }
    }
    this.value = '';
  }
});

// ══════════════════════════════════════════
//  INIT + INTERVALS
// ══════════════════════════════════════════
function init() {
  // select BTC by default
  selectAsset('crypto','BTC');
  renderTicker();

  // Price tick
  setInterval(()=>{
    tickPrices();
    renderAssetList();
    renderHero();
    renderTicker();
    updatePortfolio();
  }, 1000);

  // Update last candle
  setInterval(()=>{
    if(!candles.length) return;
    const last = candles[candles.length-1];
    last.c = curAsset.price;
    last.h = Math.max(last.h, last.c);
    last.l = Math.min(last.l, last.c);
    last.v += Math.floor(Math.random()*300);
    drawChart();
    updateOHLCV();
  }, 2000);

  // Order book
  setInterval(renderOrderBook, 1200);

  // Trades
  setInterval(addTrade, 600);
  for(let i=0;i<8;i++) setTimeout(addTrade, i*50);

  // Alerts
  setTimeout(pushAlert, 3000);
  setTimeout(pushAlert, 6000);
  setInterval(pushAlert, 10000);

  // Resize
  window.addEventListener('resize', drawChart);

  // Dismiss loader
  setTimeout(()=>{ document.getElementById('loader').classList.add('gone'); }, 2000);
}

// ══════════════════════════════════════════
//  VIEW NAVIGATION
// ══════════════════════════════════════════
const VIEWS = ['portfolio','analytics','alerts','news'];
let currentView = 'markets';

function switchView(view, el) {
  currentView = view;
  // Update nav
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  // Hide/show overlay
  VIEWS.forEach(v => {
    const ov = document.getElementById('view-'+v);
    if(ov) ov.classList.remove('active');
  });
  if(view !== 'markets') {
    const ov = document.getElementById('view-'+view);
    if(ov) ov.classList.add('active');
  }
  // Populate on open
  if(view==='portfolio') renderPortfolio();
  if(view==='analytics') renderAnalytics();
  if(view==='alerts') renderAlertsFeed();
  if(view==='news') renderNews();
}

// ══════════════════════════════════════════
//  PORTFOLIO VIEW
// ══════════════════════════════════════════
const POSITIONS = [
  {sym:'BTC', tab:'crypto', size:0.82, entry:62150},
  {sym:'ETH', tab:'crypto', size:4.5,  entry:3210},
  {sym:'NVDA',tab:'stocks', size:12,   entry:720.50},
  {sym:'SOL', tab:'crypto', size:22,   entry:145.30},
  {sym:'AAPL',tab:'stocks', size:30,   entry:172.10},
  {sym:'MSFT',tab:'stocks', size:8,    entry:395.80},
  {sym:'LINK',tab:'crypto', size:180,  entry:14.20},
];

function renderPortfolio() {
  // Positions table
  const tbody = document.getElementById('portPositions');
  let totalVal = 0;
  tbody.innerHTML = POSITIONS.map(p => {
    const a = DATA[p.tab]?.find(x=>x.sym===p.sym);
    if(!a) return '';
    const cur = a.price;
    const val = +(cur * p.size).toFixed(2);
    totalVal += val;
    const pnl = +((cur - p.entry)*p.size).toFixed(2);
    const pnlPct = +((cur - p.entry)/p.entry*100).toFixed(2);
    const up = pnl >= 0;
    return `<div class="pt-row">
      <span class="sym">${p.sym}</span>
      <span>${p.size}</span>
      <span>$${p.entry.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
      <span>$${cur.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
      <span class="${up?'up':'dn'}">${up?'+':'-'}$${Math.abs(pnl).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
      <span class="${up?'up':'dn'}">${up?'+':''}${pnlPct}%</span>
      <span>$${val.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
    </div>`;
  }).join('');

  // Allocation bars
  const allocs = POSITIONS.map(p=>{
    const a = DATA[p.tab]?.find(x=>x.sym===p.sym);
    const val = a ? a.price*p.size : 0;
    return {sym:p.sym, val};
  });
  const total = allocs.reduce((s,a)=>s+a.val,0);
  const colors = ['#c9a84c','#22d3b0','#f05d7a','#a78bfa','#60a5fa','#34d399','#fb923c'];
  document.getElementById('allocBars').innerHTML = allocs.map((a,i)=>{
    const pct = (a.val/total*100).toFixed(1);
    return `<div class="alloc-row">
      <span class="alloc-name">${a.sym}</span>
      <div class="alloc-track"><div class="alloc-fill" style="width:${pct}%;background:${colors[i%colors.length]}"></div></div>
      <span class="alloc-pct">${pct}%</span>
    </div>`;
  }).join('');

  // Update top card
  pfBase = totalVal;
  document.getElementById('pvTotal').textContent = '$'+pfBase.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}

// ══════════════════════════════════════════
//  ANALYTICS VIEW
// ══════════════════════════════════════════
function renderAnalytics() {
  const winRate = (52 + Math.random()*18).toFixed(1);
  const profitFactor = (1.2 + Math.random()*0.9).toFixed(2);
  const avgWin = '$'+(280 + Math.random()*320).toFixed(0);
  const avgLoss = '$'+(180 + Math.random()*180).toFixed(0);
  const trades = Math.floor(38 + Math.random()*30);
  const alpha = (0.8 + Math.random()*2.2).toFixed(2)+'%';
  const calmar = (0.9 + Math.random()*1.4).toFixed(2);
  const sortino = (1.1 + Math.random()*1.6).toFixed(2);

  document.getElementById('anWinRate').textContent = winRate+'%';
  document.getElementById('anPF').textContent = profitFactor;
  document.getElementById('anAvgWin').textContent = avgWin;
  document.getElementById('anAvgLoss').textContent = '-'+avgLoss;
  document.getElementById('anTrades').textContent = trades;
  document.getElementById('anAlpha').textContent = '+'+alpha;
  document.getElementById('anCalmar').textContent = calmar;
  document.getElementById('anSortino').textContent = sortino;
  document.getElementById('anWinBar').style.width = winRate+'%';

  // Trade history table - reuse pt-row but with 6 cols
  const assets = ['BTC','ETH','NVDA','SOL','AAPL','MSFT','LINK','TSLA','META','AMZN'];
  const rows = Array.from({length:10},(_,i)=>{
    const sym = assets[i%assets.length];
    const side = Math.random()>.5?'LONG':'SHORT';
    const entry = (100+Math.random()*1000).toFixed(2);
    const exit = (+entry*(1+(Math.random()-.4)*0.05)).toFixed(2);
    const pnl = ((+exit - +entry)*(side==='LONG'?1:-1)*(Math.random()*5+0.5)).toFixed(2);
    const up = pnl>=0;
    const daysAgo = Math.floor(i*3+Math.random()*2);
    const d = new Date(Date.now()-daysAgo*86400000);
    const date = d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
    return `<div class="pt-row" style="grid-template-columns:1fr 0.6fr 1fr 1fr 1fr 1fr">
      <span class="sym">${sym}</span>
      <span style="color:${side==='LONG'?'var(--up)':'var(--dn)'}">${side}</span>
      <span>$${entry}</span><span>$${exit}</span>
      <span class="${up?'up':'dn'}">${up?'+':''} $${pnl}</span>
      <span>${date}</span>
    </div>`;
  });
  document.getElementById('tradeHistoryTable').innerHTML = rows.join('');

  // Return distribution
  const returns = Array.from({length:30},()=>(Math.random()-.42)*4);
  const min = Math.min(...returns), max = Math.max(...returns), range=max-min||1;
  document.getElementById('returnDist').innerHTML = returns.map(r=>{
    const h = Math.abs(r)/Math.max(Math.abs(min),Math.abs(max))*100;
    return `<div class="rd-bar ${r>=0?'pos':'neg'}" style="height:${Math.max(8,h)}%" title="${r.toFixed(2)}%"></div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  ALERTS FEED VIEW
// ══════════════════════════════════════════
let storedAlerts = [];
let alertFilter = 'all';
let customAlerts = [];

function storeAlert(type, msg) {
  const time = new Date().toLocaleTimeString();
  storedAlerts.unshift({type, msg, time});
  if(storedAlerts.length > 50) storedAlerts.pop();
  if(currentView === 'alerts') renderAlertsFeed();
}

function filterAlerts(f, el) {
  alertFilter = f;
  document.querySelectorAll('#view-alerts .alert-filter-group .af-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  renderAlertsFeed();
}

function renderAlertsFeed() {
  const list = alertFilter === 'all' ? storedAlerts : storedAlerts.filter(a=>a.type===alertFilter);
  const feed = document.getElementById('alertsFeed');
  feed.innerHTML = list.length ? list.map(a=>`
    <div class="af-item" data-type="${a.type}">
      <div class="af-dot ${a.type}"></div>
      <span class="af-type ${a.type}">${a.type==='info'?'INFO':a.type==='up'?'BULL':'BEAR'}</span>
      <span class="af-msg">${a.msg}</span>
      <span class="af-time">${a.time}</span>
    </div>`).join('') : '<div style="padding:20px;color:var(--text3);font-size:0.72rem;font-family:DM Mono,monospace">No alerts yet…</div>';
  renderCustomAlerts();
}

function createPriceAlert() {
  const sym = document.getElementById('alertSym').value;
  const cond = document.getElementById('alertCond').value;
  const price = parseFloat(document.getElementById('alertPrice').value);
  if(!price || isNaN(price)) return;
  customAlerts.push({sym, cond, price, id: Date.now()});
  document.getElementById('alertPrice').value = '';
  renderCustomAlerts();
}

function renderCustomAlerts() {
  document.getElementById('customAlertsList').innerHTML = customAlerts.map(a=>`
    <div class="cal-item">
      <span class="cal-sym">${a.sym}</span>
      <span class="cal-cond">${a.cond==='above'?'Price above':'Price below'} $${a.price.toLocaleString()}</span>
      <span class="cal-del" onclick="removeAlert(${a.id})">✕ Remove</span>
    </div>`).join('');
}

function removeAlert(id) {
  customAlerts = customAlerts.filter(a=>a.id!==id);
  renderCustomAlerts();
}

// ══════════════════════════════════════════
//  NEWS VIEW
// ══════════════════════════════════════════
const NEWS_DATA = [
  {cat:'crypto', headline:'Bitcoin ETF Inflows Surge Past $500M Daily as Institutional Demand Accelerates', summary:'Spot Bitcoin ETFs recorded their highest single-day inflows since launch, driven by major asset managers increasing allocations ahead of the next halving cycle.', source:'CoinDesk', sentiment:'bull', time:'2m ago'},
  {cat:'macro',  headline:'Fed Minutes Reveal Split on Rate Path; Inflation Data In Focus for March Decision', summary:'Federal Reserve officials remain divided on the timing of rate cuts, with several members citing persistent services inflation as a key concern for 2024 policy.', source:'Reuters', sentiment:'neut', time:'8m ago'},
  {cat:'stocks', headline:'NVIDIA Q4 Earnings Beat by 12%, Data Center Revenue Hits Record $18.4B', summary:'NVIDIA reported blowout quarterly results driven by unprecedented demand for H100 GPUs across hyperscalers and AI startups alike.', source:'Bloomberg', sentiment:'bull', time:'15m ago'},
  {cat:'crypto', headline:'Ethereum Layer-2 Ecosystem Surpasses $50B TVL as Dencun Upgrade Approaches', summary:'Total value locked across Ethereum scaling solutions reached new highs, with Arbitrum and Base leading growth ahead of the network\'s next major upgrade.', source:'The Block', sentiment:'bull', time:'22m ago'},
  {cat:'forex',  headline:'Dollar Index Retreats as Softer PMI Data Dampens Rate Hike Expectations', summary:'The US Dollar weakened across major pairs after manufacturing PMI data came in below consensus, reducing pressure on the Fed to maintain current rate levels.', source:'FX Street', sentiment:'bear', time:'31m ago'},
  {cat:'stocks', headline:'Tesla Cuts Prices Again in China as EV Competition Intensifies', summary:'Tesla reduced prices on its Model 3 and Model Y vehicles in China for the third time this year, responding to aggressive moves by domestic manufacturers.', source:'WSJ', sentiment:'bear', time:'45m ago'},
  {cat:'macro',  headline:'China Announces New $300B Stimulus Package Targeting Infrastructure and Tech', summary:'Beijing unveiled a broad fiscal stimulus program aimed at reigniting growth, with funds directed toward semiconductor manufacturing and clean energy infrastructure.', source:'SCMP', sentiment:'bull', time:'1h ago'},
  {cat:'crypto', headline:'SEC Delays Decision on Spot Ethereum ETF Applications From Multiple Issuers', summary:'The SEC has extended its review period for Ethereum spot ETF filings from BlackRock, Fidelity, and five other applicants, citing need for additional public comment.', source:'Decrypt', sentiment:'bear', time:'1h ago'},
  {cat:'stocks', headline:'Apple Vision Pro Sales Disappoint; Company Eyes Enterprise Push for 2025', summary:'Initial Apple Vision Pro sell-through data suggests softer-than-expected consumer adoption, pushing Apple to accelerate enterprise partnership discussions.', source:'9to5Mac', sentiment:'neut', time:'2h ago'},
  {cat:'forex',  headline:'Bank of Japan Hints at Yield Curve Control Exit as CPI Hits 2.5% Target', summary:'BOJ Governor Ueda signaled growing confidence in Japan\'s inflation trajectory, raising market expectations for an end to ultra-loose monetary policy before mid-year.', source:'Nikkei', sentiment:'bull', time:'2h ago'},
  {cat:'crypto', headline:'Solana DeFi Volume Hits All-Time High Driven by Memecoin Trading Frenzy', summary:'On-chain data shows Solana DEX volumes surpassing $10B in 24 hours for the first time, with most activity concentrated in newly launched meme tokens.', source:'Blockworks', sentiment:'neut', time:'3h ago'},
  {cat:'macro',  headline:'Oil Jumps 3% After Unexpected Inventory Draw and Red Sea Shipping Disruptions', summary:'Crude prices rallied sharply after EIA data showed a significant drawdown in US oil inventories, compounded by ongoing concerns about Red Sea trade route safety.', source:'Oil Price', sentiment:'bull', time:'3h ago'},
];

let newsFilter = 'all';

function filterNews(f, el) {
  newsFilter = f;
  document.querySelectorAll('.news-filter-group .af-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  renderNews();
}

function renderNews() {
  const list = newsFilter === 'all' ? NEWS_DATA : NEWS_DATA.filter(n=>n.cat===newsFilter);
  document.getElementById('newsFeed').innerHTML = list.map((n,i)=>`
    <div class="news-card ${n.cat}" style="animation-delay:${i*0.04}s" onclick="void(0)">
      <span class="nc-tag ${n.cat}">${n.cat}</span>
      <div class="nc-headline">${n.headline}</div>
      <div class="nc-summary">${n.summary}</div>
      <div class="nc-footer">
        <span class="nc-source">${n.source} · ${n.time}</span>
        <span class="nc-sentiment ${n.sentiment}">${n.sentiment==='bull'?'▲ Bullish':n.sentiment==='bear'?'▼ Bearish':'◆ Neutral'}</span>
      </div>
    </div>`).join('');
}

window.addEventListener('load', init);
</script>
</body>
</html>
